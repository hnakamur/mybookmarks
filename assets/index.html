<!DOCTYPE html>
<html>
<head>
<title>My Bookmarks</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="/css/w2ui-1.4.2.min.css" />
<link rel="stylesheet" type="text/css" href="/css/bootstrap-3.3.2.min.css" />
<link rel="stylesheet" type="text/css" href="/css/bootstrap-theme-3.3.2.min.css" />
<link rel="stylesheet" type="text/css" href="/css/tag-editor.css" />
</head>
<body>
<div id="grid"></div>
<script src="/js/jquery-1.11.2.js"></script>
<script src="/js/w2ui-1.4.2.js"></script>
<script>
$(function () {
  var grid = $('#grid'),
      tagRegex = /^(.*)[, ]+$/,
      sepRegex = /[, ]+/m

  function formatDateTime(date) {
    return w2utils.formatDate(date, 'yyyy-mm-dd') + ' ' + w2utils.formatTime(date, "hh24:mi:ss")
  }
  function renderDateTime(date) {
    return '<div>' + formatDateTime(date) + '</div>'
  }
  function createTag(tag) {
    return $('<div class="tag-editor-tag">').append(
      $('<div class="tag-editor-text">').text(tag),
      '<a class="tag-editor-delete">x</a>'
    )
  }
  function renderTags(tags) {
    var field = $('<div class="tag-editor-field">')
    if (tags) {
      field.append(
        $.map(tags.split(sepRegex), function(tag) {
          return $('<div class="tag-editor-tag">').append(
            $('<div class="tag-editor-text">').text(tag)
          )
        })
      )
    }
    return field.html()
  }

  grid.css('width', '100%')
  grid.height($(window).height())
  $(window).on('resize', function(e) {
    grid.height($(window).height())
  })
  grid.w2grid({
    name: 'grid',
    recid: 'id',
    url: '/api/grid/bookmarks',
    show: {
      toolbar: true,
      footer: true,
      toolbarAdd: true,
      toolbarDelete: true,
      toolbarSave: true,
      toolbarEdit: true
    },
    columns: [
      { field: 'title', caption: 'Title', size: '80em',
        editable: { type: 'text' }
      },
      { field: 'url', caption: 'URL', size: '60em',
        editable: { type: 'text' }
      },
      { field: 'note', caption: 'Note', size: '60em',
        editable: { type: 'text' }
      },
      { field: 'tags', caption: 'Tags', size: '60em',
        render: function(record) { return renderTags(record.tags) },
        editable: { type: 'text' }
      },
      { field: 'created_at', caption: 'Created At', size: '40em',
        render: function(record) { return renderDateTime(record.created_at) }
      },
      { field: 'updated_at', caption: 'Updated At', size: '40em',
        render: function(record) { return renderDateTime(record.updated_at) }
      }
    ],
    toolbar: {
      onClick: function(e) {
        var grid = w2ui.grid,
            recid
        console.log('onClick', e)
        if (e.target === 'w2ui-add') {
          recid = grid.records.length + 1
          grid.add({ recid: recid })
          grid.editField(recid, 0)
        } else if (e.target === 'w2ui-edit') {
          grid.editField(grid.getSelection()[0], 0)
        }
      }
    },
    onEditField: function(e) {
      var grid = w2ui.grid,
          column = e.column,
          recid,
          index,
          tr,
          td,
          tags,
          cellInput,
          tagInput,
          tagMeasure,
          texteasure,
          tagField,
          insertTag,
          adjustInputWidth,
          finishEditTags

      console.log('onEditField', e, td)
      if (grid.columns[column].field === 'tags') {
        e.preventDefault()
        recid = e.recid
        index = grid.get(recid, true)
        tr = $('#grid_'+ grid.name +'_rec_'+ w2utils.escapeId(recid))
        td = tr.find('td[col='+ column +']')

        tagsVal = grid.records[index].tags
        tags = tagsVal ? tagsVal.split(sepRegex) : []

//        cellInput = $('<input id="grid_'+ grid.name +'_edit_'+ recid +'_'+ column +'">').css('width', 0)
//        cellInput.val(tags.join(', '))
        tagInput = $('<input class="tag-editor-input">').css('width', 0)
        tagMeasure = createTag('').css({position: 'absolute', left: "-9999px"})
        textMeasure = tagMeasure.find('.tag-editor-text')
        console.log('edit start. tags', tags)
        tagField = $('<div class="tag-editor-field">').append(
          tagMeasure,
          $.map(tags, createTag),
          tagInput
        ).css('width', '100%') 

        insertTag = function(tag) {
          if (tag && $.inArray(tag, tags) == -1) {
            tags.push(tag)
            tagInput.before(createTag(tag)).val('')
          } else {
            tagInput.val('')
          }
          adjustInputWidth('')
        }
        adjustInputWidth = function(val) {
          // To avoid juggling of input widths, we measure text width
          // with one more character.  We use 'W' here because it is
          // a wide character.
          textMeasure.text(val + 'W')
          tagInput.css('width', tagMeasure.width())
        }
        finishEditTags = function() {
          var val = tagInput.val()
          if (val) {
            insertTag(val.replace(sepRegex, ''))
          }
          grid.records[index].tags = tags.join(', ')
          tagField.remove()
          grid.refreshRow(recid)
        }
        td.addClass('w2ui-editable')
          .replaceWith(tagField) //.append(cellInput)

        tagField.on('click', function(e) {
          console.log('tagField click', e)
        })
        tagField.find('.tag-editor-delete').on('click', function(e) {
          var textElem = $(e.target).prev(),
            tag = textElem.text(),
            i = $.inArray(tag, tags)
          console.log('delete clicked, tag=', tag, ', i=', i)
          if (i != -1) {
            tags.splice(i, 1)
            textElem.parent().remove()
          }
          return false
        })
        tagInput.on('focus', function(e) {
          adjustInputWidth('')
        })
        .on('blur', function(e) {
          console.log('tagInput blur', e)
          finishEditTags()
          return false
        })
        .on('keydown', function(e) {
          var val = tagInput.val()
          console.log('keydown', e)
          if (e.which == 8 /* Backspace */ && !val && tags.length) {
            tags.pop()
            tagInput.prev().remove()
          } else if (e.which == 13 /* Enter */) {
            finishEditTags()
            console.log('keydown Enter', e)
//            if (val) {
//              insertTag(val.replace(sepRegex, ''))
//            }
//            grid.records[index].tags = tags.join(', ')
//            grid.refreshRow(recid)
//            tagField.remove()
          }
        })
        .on('keyup', function(e) {
          var val = tagInput.val(),
              matches
          if (val) {
            matches = tagRegex.exec(val)
            if (matches) {
              // We need to split tag text with separators
              // because text pasted from clipboard may contain those.
              $.each(matches[1].split(sepRegex), function(i, tag) {
                insertTag(tag)
              })
            } else {
              adjustInputWidth(val)
            }
          }
        })
        tagInput.focus()
      }
    }
  })
})
</script>

<!--CODE-->

</body>
</html>
